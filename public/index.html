<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alerta Rio Uraim</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>Bem-vindo ao Alerta Rio Uraim</h1>
    <p>Acompanhe em tempo real o nível do Rio Uraim em Paragominas-PA.</p>
  </header>

  <main>
    <section>
      <h2>Cadastre-se para receber alertas!</h2>
      <form id="form-cadastro">
        <input type="text" name="nome" placeholder="Seu nome" required>
        <input type="email" name="email" placeholder="Seu e-mail" required>
        <input type="text" name="bairro" placeholder="Seu bairro" required>
        <button type="submit">Quero receber alertas</button>
      </form>
    </section>

    <section>
      <h3>Nível atual do Rio Uraim:</h3>
      <div>
        <span id="nivel-valor">--</span>
        <span id="nivel-label"></span>
      </div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD5RHWEUk_F4nO2sYytC7InGqIotFPLWvo",
      authDomain: "site-alerta-219e8.firebaseapp.com",
      projectId: "site-alerta-219e8",
      storageBucket: "site-alerta-219e8.appspot.com",
      messagingSenderId: "972115747427",
      appId: "1:972115747427:web:94007eddafd0efbfb88e56",
      measurementId: "G-DKXX5EMXG0"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    let fcmToken = null;

    // Solicita permissão de notificação e obtém o token FCM
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        messaging.getToken({
          vapidKey: 'BML_4olUobxqhjWK13rmdVXQcKK-PtYWx7RYts8p0VgwNlZv9xq2AeAShKZvG10-fdb4TYNvR_LUv6bS2kUfTvs'
        }).then((token) => {
          fcmToken = token;
          console.log('Token FCM:', token);
        }).catch((err) => {
          console.warn('Erro ao obter token FCM:', err);
        });
      } else {
        console.warn('Permissão de notificação negada');
      }
    });

    // Atualiza nível do rio
    fetch('/nivel-rio')
      .then(r => r.json())
      .then(d => {
        const nivel = parseFloat(d.nivel);
        const nivelValor = document.getElementById('nivel-valor');
        const nivelLabel = document.getElementById('nivel-label');
        let cor = 'verde';
        let status = 'Normal';

        if (!isNaN(nivel)) {
          if (nivel >= 4) {
            cor = 'vermelho';
            status = 'Crítico';
          } else if (nivel >= 3) {
            cor = 'amarelo';
            status = 'Moderado';
          }
          nivelValor.textContent = nivel.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 2 }) + " m";
          nivelValor.className = cor;
          nivelLabel.textContent = status;
        } else {
          nivelValor.textContent = "--";
          nivelValor.className = "verde";
          nivelLabel.textContent = "";
        }
      });

    // Envia dados do formulário com token FCM
    document.getElementById('form-cadastro').addEventListener('submit', function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      data.token = fcmToken;

      fetch('/cadastrar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(r => r.text())
      .then(msg => alert(msg));

      // Salva token
      if (fcmToken) {
        fetch('/salvar-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: data.email, token: fcmToken })
        })
        .then(r => r.text())
        .then(console.log)
        .catch(console.error);
      }
    });

    // Exibe notificação se estiver com site aberto
    messaging.onMessage(function(payload) {
      alert(payload.notification.title + "\n" + payload.notification.body);
    });
  </script>
</body>
</html>